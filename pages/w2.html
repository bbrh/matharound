<html>
<head>
    <script src="jquery.min.js"></script>
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <style type="text/css">
        #svgcon {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin-left: 5em;
        }

        .site-header {
            background-color: rgba(25, 25, 25, 0.8);
            color: rgba(200, 200, 200, 0.9);
            margin-top: 0.5em;
        }

        .loading {
            position: absolute;
            top: 0;
            right: 0;
            margin-top: 0.5em;
            display: none;
        }

        body {
            margin: 0; padding: 0;
        }
    </style>
</head>
<body>
    <h1 class="site-header">nature explained</h1>
    <div id="svgcon" style="border:3px solid black; "></div>
    <div class="loading">loading...</div>


    <script type="text/javascript">
        var w = $(window).width(); // 500;
        var h = $(window).height();;
        var maxH = 10000;
        var dataset = [];
        var amtCircles = 1;

        $('#svgcon').attr('width', w - 5);

        updateData = function() {
            $('#svgcon').empty();

            if (dataset.length === 0) {
                for (var i = 0; i < amtCircles; i++) {
                    dataset.push({
                        x : Math.random() * w,
                        y : Math.random() * h,
                        r : Math.floor(Math.random() * maxH)
                    });
                }
            } else {
                console.log('updating');
                for (var i = 0; i < dataset.length; i++) {
                    var old = dataset[i];
                    dataset[i] = {
                        x : old.x + Math.random() * 2,
                        y : old.y + Math.random() * 2,
                        r : old.r + Math.random() * 2
                    }
                };
            }

            var svg = d3.select("div").append("svg")
                .attr('height', h)
                .attr('width', w);

            drawCircles(svg, dataset);
            // drawChart(svg dataset);
        };

        drawChart = function(svg, dataset) {
            var heightScale = d3.scale.sqrt()
                .domain([d3.max(dataset, function(d) { return d.r; }), 0])
                .range([0, h]);

            var yAxis = d3.svg.axis()
                .scale(heightScale)
                .orient('right')
                .ticks(4);

            var stepW = w/dataset.length;
            var rects = svg.selectAll('rect')
                .data(dataset)
                .enter()
                .append('rect')
                .attr('fill', function (d, i) {
                    return "rgb(50, 50, " + (i * 10) + ")";
                })
                .attr('x', function(d, i) {
                    return stepW * i + stepW * 0.01;
                })
                .attr('y', function(d) {
                    return heightScale(d.r);
                })
                .attr('width', stepW * 0.98)
                .attr('height', function (d) { return h - heightScale(d.r); });

            svg.selectAll('text')
                .data(dataset)
                .enter()
                .append('text')
                .attr('x', function (d, i) {
                    return stepW * i + stepW/2;
                })
                .attr('y', function (d) {
                    return heightScale(d.r) + 20;
                })
                .attr("text-anchor", "middle")
                .attr('fill', 'white')
                .text(function (d) { return d.r; });

            svg.append("g")
                .attr('class', 'axis')
                .attr('transform', 'translate(10, 0)')
                .call(yAxis);
        };

        drawCircles = function(svg, dSet) {
            svg.empty();

            var dataset = [];

            for (var si in dSet) {
                dataset.push(dSet[si]);
            }

            var circles = svg.selectAll('circle')
                .data(dataset)
                .enter()
                .append('circle');

            var drag = d3.behavior.drag()
                .origin(Object)
                .on('drag', dragmove);

            circles.attr('cx', function(d) {
                    return d.x;
                })
                .attr('cy', function(d) {
                    return d.y;
                })
                .attr('fill', function(d) {
                    return d.fill;
                })
                .attr('dataid', function(d) {
                    return d.id
                })
                .attr('r', 10)
                .on('click', function (d, i) {
                    drawField($('#svgcon'));
                    return;
                }).call(drag);

            function dragmove (d) {
                var nX = d3.event.x;
                nX = nX < 10 ? 10 : nX > w-10 ? w-10 : nX
                var nY = d3.event.y;
                nY = nY < 10 ? 10 : nY > h-10 ? h-10 : nY

                sources[d.id].x =nX;
                sources[d.id].y =nY;

                d3.select(this).attr('cx', nX).attr('cy', nY);
            };
        };

        drawSquares = function(svg, dataset) {
            svg.empty();

            var squares = svg.selectAll('rect')
                .data(dataset)
                .enter()
                .append('rect');

            var scaleO = d3.scale.linear()
                .domain([0, d3.max(dataset, function(d) { return d.o; })])
                .range([0.2, 1]);


            squares.attr('x', function(d) {
                    return d.x;
                })
                .attr('y', function(d) {
                    return d.y;
                })
                .attr('width', function(d) {
                    return d.r;
                })
                .attr('height', function(d) {
                    return d.r;
                })
                .attr('opacity', function(d) {
                    return scaleO(d.o);
                });
        };

        var sources = {
            0 : { x:w/5,   y:h/3,   wavelength:10,  amplitude:10, id:0, fill:'green' },
            // 1 : { x:w/2, y:w/2, wavelength:15, amplitude:10, id:1, fill:'orange' },
            2 : { x:w/5,   y:h*2/3,   wavelength:10, amplitude:10,  id:2, fill:'yellow' },
        };

        function drawField(svg) {
            $('.loading').show();
            svg.empty();

            var svg = d3.select("div").append("svg")
                .attr('height', h)
                .attr('width', w);
            var pixelSize = 10;
            var dSet = [];
            for (var x=0; x<w; x+=pixelSize) {
                for (var y=0; y<h; y+=pixelSize) {
                    dSet.push({
                        x:x, y:y, r:pixelSize,
                        o: waveFun(sources, { x:x, y:y })
                    });
                }
            }

            drawSquares(svg, dSet);
            drawCircles(svg, sources);
            $('.loading').hide();
        };

        function distance(a, b) {
            return Math.pow(Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2), 0.5)
        };

        function waveFun(sources, point) {
            var res = 0;
            for (var si in sources) {
                res += sources[si].amplitude *
                    (1 + Math.cos(distance(point, sources[si]) /
                        w*sources[si].wavelength*Math.PI))
            }
            return res;
        }

        // updateData();
        drawField($('#svgcon'));
    </script>
    </body>
</html>
